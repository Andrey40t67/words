<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #videoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        #video {
            display: none;
        }

        #canvas3d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        .start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .start-screen h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        #startBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        #startBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 50;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            background: #f0f0f0;
            color: #333;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: #667eea;
            color: white;
        }

        .color-picker {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 50;
            display: none;
            min-width: 200px;
        }

        .info-panel h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .gesture-info {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .virtual-button {
            position: absolute;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 20;
            transition: all 0.3s;
        }

        .virtual-button.hover {
            background: rgba(118, 75, 162, 0.9);
            transform: scale(1.1);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 100;
            display: none;
        }

        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="drawingCanvas"></canvas>
    <canvas id="canvas3d"></canvas>
    <div class="particles" id="particles"></div>

    <div class="start-screen" id="startScreen">
        <h1>ü§ö Hand Tracking Control</h1>
        <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–∞–π—Ç–æ–º —Å –ø–æ–º–æ—â—å—é –∂–µ—Å—Ç–æ–≤ —Ä—É–∫!</p>
        <p style="font-size: 0.9em; color: #999;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</p>
        <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
    </div>

    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...</div>

    <div class="controls" id="controls">
        <h3>–†–µ–∂–∏–º—ã</h3>
        <div class="btn-group">
            <button class="control-btn active" id="drawMode">‚úèÔ∏è –†–∏—Å–æ–≤–∞–Ω–∏–µ</button>
            <button class="control-btn" id="gestureMode">üëã –ñ–µ—Å—Ç—ã</button>
            <button class="control-btn" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="colorPicker" class="color-picker">
            <div class="color-option selected" style="background: #FF6B6B" data-color="#FF6B6B"></div>
            <div class="color-option" style="background: #4ECDC4" data-color="#4ECDC4"></div>
            <div class="color-option" style="background: #45B7D1" data-color="#45B7D1"></div>
            <div class="color-option" style="background: #96CEB4" data-color="#96CEB4"></div>
            <div class="color-option" style="background: #FFEAA7" data-color="#FFEAA7"></div>
            <div class="color-option" style="background: #DDA0DD" data-color="#DDA0DD"></div>
            <div class="color-option" style="background: #98D8C8" data-color="#98D8C8"></div>
            <div class="color-option" style="background: #FFFFFF" data-color="#FFFFFF"></div>
        </div>
    </div>

    <div class="info-panel" id="infoPanel">
        <h4>–ñ–µ—Å—Ç—ã:</h4>
        <div class="gesture-info">
            ‚úåÔ∏è Peace - –†–∏—Å–æ–≤–∞–Ω–∏–µ<br>
            ‚úä –ö—É–ª–∞–∫ - –ü–∞—É–∑–∞<br>
            üñêÔ∏è –õ–∞–¥–æ–Ω—å - –°—Ç–µ—Ä–µ—Ç—å<br>
            üëç –ü–∞–ª–µ—Ü –≤–≤–µ—Ä—Ö - –ú–µ–Ω—é
        </div>
    </div>

    <div class="virtual-button" id="virtualBtn1" style="top: 200px; left: 50%; transform: translateX(-50%);">
        –ù–∞–≤–µ–¥–∏—Ç–µ —Ä—É–∫—É
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        let video, canvas3d, ctx3d, drawingCanvas, drawCtx;
        let hands, camera;
        let currentMode = 'draw';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentColor = '#FF6B6B';
        let prevHandData = null;
        let particles = [];

        const startBtn = document.getElementById('startBtn');
        const startScreen = document.getElementById('startScreen');
        const controls = document.getElementById('controls');
        const infoPanel = document.getElementById('infoPanel');
        const loading = document.getElementById('loading');
        const virtualBtn1 = document.getElementById('virtualBtn1');

        startBtn.addEventListener('click', async () => {
            startScreen.style.display = 'none';
            loading.style.display = 'block';
            await initializeHandTracking();
        });

        async function initializeHandTracking() {
            video = document.getElementById('video');
            canvas3d = document.getElementById('canvas3d');
            ctx3d = canvas3d.getContext('2d');
            drawingCanvas = document.getElementById('drawingCanvas');
            drawCtx = drawingCanvas.getContext('2d');

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
            function resizeCanvases() {
                canvas3d.width = window.innerWidth;
                canvas3d.height = window.innerHeight;
                drawingCanvas.width = window.innerWidth;
                drawingCanvas.height = window.innerHeight;
            }
            resizeCanvases();
            window.addEventListener('resize', resizeCanvases);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe Hands
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandResults);

            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                },
                width: 1280,
                height: 720
            });

            camera.start().then(() => {
                loading.style.display = 'none';
                controls.style.display = 'block';
                infoPanel.style.display = 'block';
            });
        }

        function onHandResults(results) {
            // –û—á–∏—Å—Ç–∫–∞ 3D canvas
            ctx3d.clearRect(0, 0, canvas3d.width, canvas3d.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawHand3D(landmarks);
                    processGestures(landmarks);
                    
                    if (currentMode === 'draw') {
                        handleDrawing(landmarks);
                    }
                    
                    checkVirtualButtonHover(landmarks);
                }
            }

            prevHandData = results.multiHandLandmarks;
        }

        function drawHand3D(landmarks) {
            const connections = [
                [0, 1], [1, 2], [2, 3], [3, 4],  // –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü
                [0, 5], [5, 6], [6, 7], [7, 8],  // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π
                [0, 9], [9, 10], [10, 11], [11, 12],  // –°—Ä–µ–¥–Ω–∏–π
                [0, 13], [13, 14], [14, 15], [15, 16],  // –ë–µ–∑—ã–º—è–Ω–Ω—ã–π
                [0, 17], [17, 18], [18, 19], [19, 20],  // –ú–∏–∑–∏–Ω–µ—Ü
                [5, 9], [9, 13], [13, 17]  // –õ–∞–¥–æ–Ω—å
            ];

            // –†–∏—Å—É–µ–º —Å–≤—è–∑–∏
            ctx3d.strokeStyle = 'rgba(100, 200, 255, 0.6)';
            ctx3d.lineWidth = 3;
            
            connections.forEach(connection => {
                const start = landmarks[connection[0]];
                const end = landmarks[connection[1]];
                
                ctx3d.beginPath();
                ctx3d.moveTo(start.x * canvas3d.width, start.y * canvas3d.height);
                ctx3d.lineTo(end.x * canvas3d.width, end.y * canvas3d.height);
                ctx3d.stroke();
            });

            // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
            landmarks.forEach((landmark, index) => {
                const x = landmark.x * canvas3d.width;
                const y = landmark.y * canvas3d.height;
                
                // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ç–æ—á–µ–∫
                const gradient = ctx3d.createRadialGradient(x, y, 0, x, y, 10);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                gradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.7)');
                gradient.addColorStop(1, 'rgba(100, 200, 255, 0.3)');
                
                ctx3d.fillStyle = gradient;
                ctx3d.beginPath();
                ctx3d.arc(x, y, index === 8 ? 12 : 8, 0, 2 * Math.PI);
                ctx3d.fill();
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è
                ctx3d.shadowBlur = 20;
                ctx3d.shadowColor = 'rgba(100, 200, 255, 0.8)';
                ctx3d.fill();
                ctx3d.shadowBlur = 0;
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
            if (Math.random() > 0.7) {
                createParticle(landmarks[8].x * canvas3d.width, landmarks[8].y * canvas3d.height);
            }
        }

        function handleDrawing(landmarks) {
            const indexTip = landmarks[8];
            const x = indexTip.x * drawingCanvas.width;
            const y = indexTip.y * drawingCanvas.height;

            const thumbTip = landmarks[4];
            const distance = Math.sqrt(
                Math.pow(indexTip.x - thumbTip.x, 2) + 
                Math.pow(indexTip.y - thumbTip.y, 2)
            );

            // –†–∏—Å—É–µ–º –∫–æ–≥–¥–∞ –±–æ–ª—å—à–æ–π –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª—å—Ü—ã —Å–≤–µ–¥–µ–Ω—ã
            if (distance < 0.05) {
                if (!isDrawing) {
                    isDrawing = true;
                    lastX = x;
                    lastY = y;
                } else {
                    drawCtx.strokeStyle = currentColor;
                    drawCtx.lineWidth = 5;
                    drawCtx.lineCap = 'round';
                    drawCtx.beginPath();
                    drawCtx.moveTo(lastX, lastY);
                    drawCtx.lineTo(x, y);
                    drawCtx.stroke();
                    lastX = x;
                    lastY = y;
                }
            } else {
                isDrawing = false;
            }
        }

        function processGestures(landmarks) {
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–æ–≤
            const gesture = detectGesture(landmarks);
            
            if (gesture === 'peace') {
                currentMode = 'draw';
                document.getElementById('drawMode').classList.add('active');
                document.getElementById('gestureMode').classList.remove('active');
            } else if (gesture === 'fist') {
                // –ü–∞—É–∑–∞
            } else if (gesture === 'open_palm') {
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å—Ç–∏—Ä–∞–Ω–∏—è
            }
        }

        function detectGesture(landmarks) {
            // –ü—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–æ–≤
            const fingerTips = [4, 8, 12, 16, 20];
            const fingerBases = [2, 5, 9, 13, 17];
            
            let extendedFingers = 0;
            
            for (let i = 1; i < fingerTips.length; i++) {
                if (landmarks[fingerTips[i]].y < landmarks[fingerBases[i]].y) {
                    extendedFingers++;
                }
            }
            
            if (extendedFingers === 0) return 'fist';
            if (extendedFingers === 2) return 'peace';
            if (extendedFingers >= 4) return 'open_palm';
            
            return 'unknown';
        }

        function checkVirtualButtonHover(landmarks) {
            const indexTip = landmarks[8];
            const x = indexTip.x * window.innerWidth;
            const y = indexTip.y * window.innerHeight;
            
            const btnRect = virtualBtn1.getBoundingClientRect();
            
            if (x >= btnRect.left && x <= btnRect.right && 
                y >= btnRect.top && y <= btnRect.bottom) {
                virtualBtn1.classList.add('hover');
                virtualBtn1.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!';
            } else {
                virtualBtn1.classList.remove('hover');
                virtualBtn1.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ —Ä—É–∫—É';
            }
        }

        function createParticle(x, y) {
            const particle = {
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                life: 1.0,
                color: `hsl(${Math.random() * 60 + 200}, 100%, 70%)`
            };
            particles.push(particle);
        }

        function animateParticles() {
            ctx3d.globalCompositeOperation = 'lighter';
            
            particles = particles.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life -= 0.02;
                
                if (particle.life > 0) {
                    ctx3d.globalAlpha = particle.life;
                    ctx3d.fillStyle = particle.color;
                    ctx3d.beginPath();
                    ctx3d.arc(particle.x, particle.y, 3 * particle.life, 0, Math.PI * 2);
                    ctx3d.fill();
                    return true;
                }
                return false;
            });
            
            ctx3d.globalAlpha = 1;
            ctx3d.globalCompositeOperation = 'source-over';
            
            requestAnimationFrame(animateParticles);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('drawMode').addEventListener('click', () => {
            currentMode = 'draw';
            document.getElementById('drawMode').classList.add('active');
            document.getElementById('gestureMode').classList.remove('active');
        });

        document.getElementById('gestureMode').addEventListener('click', () => {
            currentMode = 'gesture';
            document.getElementById('gestureMode').classList.add('active');
            document.getElementById('drawMode').classList.remove('active');
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        });

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
        document.querySelectorAll('.color-option').forEach(colorOption => {
            colorOption.addEventListener('click', (e) => {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                e.target.classList.add('selected');
                currentColor = e.target.dataset.color;
            });
        });

        // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∞—Å—Ç–∏—Ü
        animateParticles();
    </script>
</body>
</html>
